ğŸš‚ Express Middleware Deep Dive
1ï¸âƒ£ What is Middleware?

Middleware = function that executes during request â†’ response cycle.

Client â†’ Middleware1 â†’ Middleware2 â†’ Route Handler â†’ Response

ğŸ”¹ Types

Application-level â†’ app.use()

Router-level â†’ router.use()

Error-handling â†’ (err, req, res, next)

Built-in â†’ express.json(), express.static()

Third-party â†’ cors(), helmet()

2ï¸âƒ£ next() â€” The Key
ğŸ”¹ Purpose

Tells Express: â€œCall the next middleware in lineâ€

Without it â†’ request stops and hangs

âœ… Example
const express = require('express');
const app = express();

const logger = (req, res, next) => {
  console.log(`${req.method} ${req.url}`);
  next(); // pass control to next middleware or route
};

app.use(logger);

app.get('/', (req, res) => {
  res.send('Hello World');
});

app.listen(5000);


ğŸ”¹ Output when client hits /:

GET /

âš ï¸ Trap

âŒ Forgetting next() â†’ request hangs
âœ” Only skip next() if sending a response (res.send/res.json)

3ï¸âƒ£ Custom Middleware Example
ğŸ”¹ Logger + Timestamp + IP
const customLogger = (req, res, next) => {
  req.requestTime = new Date();
  console.log(`[${req.method}] ${req.url} - ${req.ip} at ${req.requestTime}`);
  next();
};

app.use(customLogger);

app.get('/users', (req, res) => {
  res.json({
    message: "User list",
    requestedAt: req.requestTime
  });
});


âœ… Adds custom info to request object
âœ… Can be reused in multiple routes

4ï¸âƒ£ Middleware + Route Handler Flow

Request Lifecycle Simplified

Client â†’ app-level middleware â†’ router-level middleware â†’ route handler â†’ response â†’ error middleware

ğŸ”¹ Detailed Flow

Client sends request â†’ /users

app.use(logger) executes

logs request

calls next()

router.use(authMiddleware) executes (if route in router)

verifies JWT

calls next() or stops

Route handler executes

returns JSON / HTML / data

Error middleware (if any error thrown)

app.use((err, req, res, next) => {})

5ï¸âƒ£ Error Handling Middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ message: err.message });
});


ğŸ”¹ Must have 4 parameters â†’ Express identifies it as error handler

6ï¸âƒ£ Logger + Middleware Example (Complete)
const express = require('express');
const app = express();

// Built-in JSON parser
app.use(express.json());

// Custom logger middleware
app.use((req, res, next) => {
  console.log(`[${req.method}] ${req.url} - ${new Date().toISOString()}`);
  next();
});

// Router-level middleware
const userRouter = express.Router();
userRouter.use((req, res, next) => {
  console.log('Router-level middleware triggered');
  next();
});

// Routes
userRouter.get('/', (req, res) => {
  res.json({ users: [] });
});
userRouter.post('/', (req, res) => {
  res.status(201).json({ user: req.body });
});

app.use('/api/users', userRouter);

// Error handler
app.use((err, req, res, next) => {
  res.status(500).json({ message: err.message });
});

app.listen(5000, () => console.log('Server running on port 5000'));

7ï¸âƒ£ Key Interview Takeaways
Concept	Note
next()	Passes control to next middleware
Middleware	Can mutate req or res objects
Application-level	app.use() â†’ global
Router-level	router.use() â†’ specific routes
Error middleware	Needs 4 params (err, req, res, next)
Request lifecycle	Client â†’ app middleware â†’ router â†’ route â†’ response â†’ error